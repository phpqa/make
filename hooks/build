#!/bin/bash

set -e

printf "Environment variables:\\n"

printf "SOURCE_BRANCH=\"${SOURCE_BRANCH}\"\\n"
printf "SOURCE_COMMIT=\"${SOURCE_COMMIT}\"\\n"
printf "COMMIT_MSG=\"${COMMIT_MSG}\"\\n"
printf "DOCKER_REPO=\"${DOCKER_REPO}\"\\n"
printf "DOCKERFILE_PATH=\"${DOCKERFILE_PATH}\"\\n"
printf "CACHE_TAG=\"${CACHE_TAG}\"\\n"
printf "IMAGE_NAME=\"${IMAGE_NAME}\"\\n"

printf "Build variables:\\n"

TAG="${CACHE_TAG}"
if test "${CACHE_TAG}" = "latest"; then
    TAG_BASE_IMAGE_PART=$(sed -n "s/ARG BASE_IMAGE=\"\(.*\)\"/\1/p" Dockerfile | sed -e '1 s/:/-/; t')
    TAG_VERSION_PART=$(sed -n "s/ARG VERSION=\"\(.*\)\"/\1/p" Dockerfile)
    TAG="${TAG_VERSION_PART}-on-${TAG_BASE_IMAGE_PART}"
fi

BASE_IMAGE=$(echo ${TAG} | awk -F "-on-" '{print $2}' | sed -e '1 s/\-/:/; t')
VERSION=$(echo ${TAG} | awk -F "-on-" '{print $1}')

printf "BASE_IMAGE=\"${BASE_IMAGE}\"\\n"
printf "VERSION=\"${VERSION}\"\\n"
printf "DOCKERFILE_PATH=\"${DOCKERFILE_PATH}\"\\n"
printf "TAG=\"${TAG}\"\\n"

docker build \
    --build-arg BASE_IMAGE=${BASE_IMAGE} \
    --build-arg VERSION=${VERSION} \
    --file ${DOCKERFILE_PATH} \
    --tag ${DOCKER_REPO}:${TAG} \
    .
